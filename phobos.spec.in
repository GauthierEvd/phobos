Name:    @PACKAGE@
Version: @VERSION@
Release: @RELEASE@%{?dist}
Summary: Parallel Heterogeneous OBject-Oriented Storage

Group:   Applications/System
License: LGPLv2.1
URL:     http://www-hpc.cea.fr
Source0: %{name}-%{version}.tar.gz

%define phobosdocdir %{_docdir}/%{name}

%define __python /usr/bin/python2

%if 0%{?rhel} >= 8
%global python_prefix python2
%global postgres_prefix postgresql
%else
%global python_prefix python
%global postgres_prefix postgresql94
%endif

BuildRequires: %{postgres_prefix}-devel
BuildRequires: glib2-devel >= 2.28
BuildRequires: %{python_prefix}-devel
BuildRequires: jansson-devel >= 2.5
BuildRequires: libini_config-devel
BuildRequires: openssl-devel
BuildRequires: libattr-devel
BuildRequires: sg3_utils-devel
BuildRequires: protobuf-c-devel
BuildRequires: systemd

Requires: %{postgres_prefix}-server
Requires: %{postgres_prefix}-contrib
Requires: glib2 >= 2.28
Requires: jansson
Requires: libini_config
Requires: openssl
Requires: attr
Requires: libattr
Requires: %{python_prefix}
%if 0%{?rhel} < 8
Requires: python-argparse
%endif
Requires: %{python_prefix}-yaml
Requires: %{python_prefix}-clustershell
Requires: %{python_prefix}-psycopg2
Requires: %{python_prefix}-tabulate
Requires: protobuf
Requires: protobuf-c

%description
Phobos aims to implement high performance distributed object storage on a wide
variety of media including tapes, disks, other object stores...
This initial version is however limited to a single host. It can manage tapes
in a SCSI library and local directories.

%package devel
Summary: C API for Phobos Object Store.
%description devel
This package contains header files and required libraries to access Phobos
object store from a C program.

%prep
%setup -q


%build
%if 0%{?rhel} < 8
export PKG_CONFIG_PATH=/usr/pgsql-9.4/lib/pkgconfig
%endif
%configure
make %{?_smp_mflags}


%install
%make_install
install -D -p -m 0640 doc/cfg/template.conf %{buildroot}/%{_sysconfdir}/phobos.conf
# create another copy of configuration in documentation directory
install -D -p -m 0640 doc/cfg/template.conf %{buildroot}/%{phobosdocdir}/template.conf
install -p -m 0640 README.md %{buildroot}/%{phobosdocdir}/README.md
cd %{_builddir}/%{name}-%{version}/src/cli/
%{__python} setup.py install --skip-build --root %{buildroot}

rm -f $RPM_BUILD_ROOT/%{_libdir}/phobos/libpho_layout_*.a
rm -f $RPM_BUILD_ROOT/%{_libdir}/phobos/libpho_layout_*.la


%files

%{_libdir}/libphobos_store.so*
%{_libdir}/libphobos_admin.so*
%{_libdir}/phobos/libpho_layout_*.so*
%{_sbindir}/pho_*_helper
%{_sbindir}/phobos_db
%{python_sitearch}/phobos/*
%{python_sitearch}/phobos-*-py?.?.egg-info
%{_bindir}/phobos
%{_sbindir}/phobosd
%{_unitdir}/phobosd.service
%config(noreplace) %{_sysconfdir}/phobos.conf
%dir %{phobosdocdir}
%doc %{phobosdocdir}/README.md
%doc %{phobosdocdir}/template.conf

%files devel

%{_includedir}/pho_attrs.h
%{_includedir}/phobos_store.h
%{_includedir}/phobos_admin.h
%{_libdir}/libphobos_store.la
%{_libdir}/libphobos_admin.la

%changelog
* Thu Sep 10 2020 - Thomas Leibovici <thomas.leibovici@cea.fr> - 1.90.0-1
- Release 1.90 (Hi'iaka): 1.9x is the release cycle towards 2.0
- Phobos now runs a daemon (phobosd) on each IO node to manage devices and
  schedule IOs
- Object and extent listing and filtering commands
- Layout and family selection from (m)put command line
- Split too large extents on multiple media
- Port to RHEL/CentOS8
- Various fixes and refactoring

* Fri Jan 10 2020 - Thomas Leibovici <thomas.leibovici@cea.fr> - 1.3.1-1
- Pass 'scsi generic' devices to LTFS instead of 'scsi tape'.

* Tue Nov 26 2019 - Thomas Leibovici <thomas.leibovici@cea.fr> - 1.3.0-1
- Release 1.3 (Vala)
- Now uses LTFS 2.4. No longer requires lin_tape.
- Media list filter by tag, e.g. "phobos tape list -T foo,bar"
- Drive list filter by model, e.g. "phobos drive list -m ULTRIUM-TD6"
- Fix various memory leaks and wrong behaviors

* Thu Jul 18 2019 - Thomas Leibovici <thomas.leibovici@cea.fr> - 1.2.0-1
- Final 1.2 release (Echo)
- New features:
    * Dual logging (stderr and syslog)
    * phobos lib scan (improved 'mtx status')
    * phobos_db tool (DB schema management, DB migration)
    * retry when the number of concurrent PUT/GET > nb drives
    * media tag management
    * manage drive-tape compatibility rules (WIP)

* Mon Jan 15 2018 - Thomas Leibovici <thomas.leibovici@cea.fr> - 1.1-4
- Minor refresh with latest patches

* Fri Sep 08 2017 - Henri Doreau <henri.doreau@cea.fr> - 1.1-3
- Propery set LGPL headers to the project files
- Reimplement CLI using ctypes instead of SWIG
- Fix a bug where errors on flush would trigger an assertion failure
- Misc packaging improvements to meet ocean quality standards

* Fri Aug 04 2017 - Thomas Leibovici <thomas.leibovici@cea.fr> - 1.1-2
- Change DB conversion script to properly convert JSON integers
- Make DSS resilient to missing stats fields in JSONs
- Fix default commands for ltfs mount/umount/format
- Don't leave a drive busy when its filesystem is full
- Fix invalid write intent size of 0
- Set rpath to load layout modules
- SCSI library: check target slot is empty before move
- Make tape move resilient to invalid slot

* Wed Jun 21 2017 - Thomas Leibovici <thomas.leibovici@cea.fr> - 1.1-1
- Generic Layout management + 2 implementations: 'simple' and 'raid1'.
- Configuration changes. See installed template (see /etc/phobos.conf.rpmnew).
- Set filesystem label at format time, and check it at mount time.
- Improved management of full devices (set R/O, tag full...)
- SCSI library: when needed, search free slot to unload a tape to.
- Phobos 1.0 to phobos 1.1 DB conversion script.
- New DSS filter API (no change in commands or user interface).
- Miscellaneous bug fixes
